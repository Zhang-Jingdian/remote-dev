{% extends "base.html" %}

{% block title %}集群管理{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-server"></i> 集群管理
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>服务器节点</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>节点</th>
                                            <th>状态</th>
                                            <th>负载</th>
                                            <th>内存</th>
                                            <th>网络</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for server in servers %}
                                        <tr>
                                            <td>
                                                <strong>{{ server.name }}</strong><br>
                                                <small class="text-muted">{{ server.host }}</small>
                                            </td>
                                            <td>
                                                <span
                                                    class="badge badge-{{ 'success' if server.status == 'online' else 'danger' }}">
                                                    {{ server.status }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar" role="progressbar"
                                                        style="width: {{ server.cpu_usage }}%"
                                                        aria-valuenow="{{ server.cpu_usage }}" aria-valuemin="0"
                                                        aria-valuemax="100">
                                                        {{ server.cpu_usage }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-info" role="progressbar"
                                                        style="width: {{ server.memory_usage }}%"
                                                        aria-valuenow="{{ server.memory_usage }}" aria-valuemin="0"
                                                        aria-valuemax="100">
                                                        {{ server.memory_usage }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span
                                                    class="badge badge-{{ 'success' if server.network_latency < 50 else 'warning' }}">
                                                    {{ server.network_latency }}ms
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-info"
                                                        onclick="viewServer('{{ server.id }}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-warning"
                                                        onclick="restartServer('{{ server.id }}')">
                                                        <i class="fas fa-redo"></i>
                                                    </button>
                                                    <button class="btn btn-danger"
                                                        onclick="removeServer('{{ server.id }}')">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5>集群操作</h5>
                            <div class="btn-group-vertical btn-block mb-3">
                                <button class="btn btn-primary" onclick="addServer()">
                                    <i class="fas fa-plus"></i> 添加服务器
                                </button>
                                <button class="btn btn-success" onclick="balanceLoad()">
                                    <i class="fas fa-balance-scale"></i> 负载均衡
                                </button>
                                <button class="btn btn-info" onclick="healthCheck()">
                                    <i class="fas fa-heartbeat"></i> 健康检查
                                </button>
                                <button class="btn btn-warning" onclick="maintenanceMode()">
                                    <i class="fas fa-tools"></i> 维护模式
                                </button>
                            </div>

                            <h5>集群统计</h5>
                            <div class="info-box">
                                <div class="info-box-content">
                                    <span class="info-box-text">总节点数</span>
                                    <span class="info-box-number">{{ cluster_stats.total_nodes }}</span>
                                </div>
                            </div>
                            <div class="info-box">
                                <div class="info-box-content">
                                    <span class="info-box-text">在线节点</span>
                                    <span class="info-box-number">{{ cluster_stats.online_nodes }}</span>
                                </div>
                            </div>
                            <div class="info-box">
                                <div class="info-box-content">
                                    <span class="info-box-text">平均负载</span>
                                    <span class="info-box-number">{{ cluster_stats.avg_load }}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加服务器模态框 -->
<div class="modal fade" id="addServerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加服务器</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addServerForm">
                    <div class="form-group">
                        <label for="serverName">服务器名称</label>
                        <input type="text" class="form-control" id="serverName" required>
                    </div>
                    <div class="form-group">
                        <label for="serverHost">主机地址</label>
                        <input type="text" class="form-control" id="serverHost" required>
                    </div>
                    <div class="form-group">
                        <label for="serverPort">端口</label>
                        <input type="number" class="form-control" id="serverPort" value="22" required>
                    </div>
                    <div class="form-group">
                        <label for="serverUser">用户名</label>
                        <input type="text" class="form-control" id="serverUser" required>
                    </div>
                    <div class="form-group">
                        <label for="serverRole">角色</label>
                        <select class="form-control" id="serverRole">
                            <option value="worker">Worker</option>
                            <option value="backup">Backup</option>
                            <option value="master">Master</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveServer()">添加</button>
            </div>
        </div>
    </div>
</div>

<script>
    function addServer() {
        $('#addServerModal').modal('show');
    }

    function saveServer() {
        const formData = {
            name: document.getElementById('serverName').value,
            host: document.getElementById('serverHost').value,
            port: document.getElementById('serverPort').value,
            user: document.getElementById('serverUser').value,
            role: document.getElementById('serverRole').value
        };

        fetch('/api/cluster/add-server', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#addServerModal').modal('hide');
                    location.reload();
                } else {
                    alert('添加失败: ' + data.message);
                }
            });
    }

    function viewServer(serverId) {
        window.open('/cluster/server/' + serverId, '_blank');
    }

    function restartServer(serverId) {
        if (confirm('确定要重启这个服务器吗？')) {
            fetch('/api/cluster/restart-server', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ server_id: serverId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('服务器重启成功');
                        location.reload();
                    } else {
                        alert('重启失败: ' + data.message);
                    }
                });
        }
    }

    function removeServer(serverId) {
        if (confirm('确定要移除这个服务器吗？')) {
            fetch('/api/cluster/remove-server', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ server_id: serverId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('服务器移除成功');
                        location.reload();
                    } else {
                        alert('移除失败: ' + data.message);
                    }
                });
        }
    }

    function balanceLoad() {
        fetch('/api/cluster/balance-load', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('负载均衡完成');
                    location.reload();
                } else {
                    alert('负载均衡失败: ' + data.message);
                }
            });
    }

    function healthCheck() {
        fetch('/api/cluster/health-check', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('健康检查完成');
                    location.reload();
                } else {
                    alert('健康检查失败: ' + data.message);
                }
            });
    }

    function maintenanceMode() {
        if (confirm('确定要进入维护模式吗？')) {
            fetch('/api/cluster/maintenance-mode', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('已进入维护模式');
                        location.reload();
                    } else {
                        alert('进入维护模式失败: ' + data.message);
                    }
                });
        }
    }

    // 自动刷新状态
    setInterval(function () {
        fetch('/api/cluster/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新状态显示
                    updateClusterStatus(data.status);
                }
            });
    }, 5000);

    function updateClusterStatus(status) {
        // 更新集群状态显示
        // 这里可以添加实时状态更新逻辑
    }
</script>
{% endblock %}