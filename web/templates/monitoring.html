{% extends "base.html" %}

{% block title %}监控中心{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-line"></i> 监控中心
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-info">
                                    <i class="fas fa-server"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">系统负载</span>
                                    <span class="info-box-number" id="system-load">0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-success">
                                    <i class="fas fa-memory"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">内存使用</span>
                                    <span class="info-box-number" id="memory-usage">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-warning">
                                    <i class="fas fa-network-wired"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">网络流量</span>
                                    <span class="info-box-number" id="network-traffic">0 KB/s</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box">
                                <span class="info-box-icon bg-danger">
                                    <i class="fas fa-hdd"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">磁盘使用</span>
                                    <span class="info-box-number" id="disk-usage">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5>性能图表</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="performanceChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>实时日志</h5>
                                </div>
                                <div class="card-body">
                                    <div id="realtime-logs"
                                        style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                                        <!-- 实时日志将在这里显示 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>服务状态</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>服务</th>
                                                    <th>状态</th>
                                                    <th>CPU</th>
                                                    <th>内存</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="services-table">
                                                <!-- 服务状态将在这里显示 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>告警信息</h5>
                                </div>
                                <div class="card-body">
                                    <div id="alerts-container">
                                        <!-- 告警信息将在这里显示 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let performanceChart;

    // 初始化性能图表
    function initPerformanceChart() {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU使用率',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }, {
                    label: '内存使用率',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    // 更新性能数据
    function updatePerformanceData() {
        fetch('/api/monitoring/metrics')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const metrics = data.metrics;

                    // 更新统计信息
                    document.getElementById('system-load').textContent = metrics.system_load.toFixed(2);
                    document.getElementById('memory-usage').textContent = metrics.memory_usage + '%';
                    document.getElementById('network-traffic').textContent = metrics.network_traffic + ' KB/s';
                    document.getElementById('disk-usage').textContent = metrics.disk_usage + '%';

                    // 更新图表
                    const now = new Date().toLocaleTimeString();
                    performanceChart.data.labels.push(now);
                    performanceChart.data.datasets[0].data.push(metrics.cpu_usage);
                    performanceChart.data.datasets[1].data.push(metrics.memory_usage);

                    // 保持最近20个数据点
                    if (performanceChart.data.labels.length > 20) {
                        performanceChart.data.labels.shift();
                        performanceChart.data.datasets[0].data.shift();
                        performanceChart.data.datasets[1].data.shift();
                    }

                    performanceChart.update();
                }
            });
    }

    // 更新服务状态
    function updateServicesStatus() {
        fetch('/api/monitoring/services')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tbody = document.getElementById('services-table');
                    tbody.innerHTML = '';

                    data.services.forEach(service => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                    <td>${service.name}</td>
                    <td>
                        <span class="badge badge-${service.status === 'running' ? 'success' : 'danger'}">
                            ${service.status}
                        </span>
                    </td>
                    <td>${service.cpu_usage}%</td>
                    <td>${service.memory_usage}%</td>
                    <td>
                        <button class="btn btn-sm btn-${service.status === 'running' ? 'warning' : 'success'}" 
                                onclick="${service.status === 'running' ? 'stopService' : 'startService'}('${service.name}')">
                            ${service.status === 'running' ? '停止' : '启动'}
                        </button>
                    </td>
                `;
                        tbody.appendChild(row);
                    });
                }
            });
    }

    // 更新告警信息
    function updateAlerts() {
        fetch('/api/monitoring/alerts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const container = document.getElementById('alerts-container');
                    container.innerHTML = '';

                    data.alerts.forEach(alert => {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = `alert alert-${alert.level} alert-dismissible fade show`;
                        alertDiv.innerHTML = `
                    <strong>${alert.title}</strong> ${alert.message}
                    <small class="d-block text-muted">${alert.timestamp}</small>
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                `;
                        container.appendChild(alertDiv);
                    });
                }
            });
    }

    // 更新实时日志
    function updateRealtimeLogs() {
        fetch('/api/monitoring/logs')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const logsContainer = document.getElementById('realtime-logs');

                    data.logs.forEach(log => {
                        const logDiv = document.createElement('div');
                        logDiv.className = `text-${log.level === 'ERROR' ? 'danger' : log.level === 'WARNING' ? 'warning' : 'info'}`;
                        logDiv.textContent = `[${log.timestamp}] ${log.level}: ${log.message}`;
                        logsContainer.appendChild(logDiv);
                    });

                    // 保持最新的日志在底部
                    logsContainer.scrollTop = logsContainer.scrollHeight;

                    // 限制日志数量
                    while (logsContainer.children.length > 100) {
                        logsContainer.removeChild(logsContainer.firstChild);
                    }
                }
            });
    }

    // 服务控制
    function startService(serviceName) {
        fetch('/api/monitoring/start-service', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ service: serviceName })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateServicesStatus();
                } else {
                    alert('启动服务失败: ' + data.message);
                }
            });
    }

    function stopService(serviceName) {
        if (confirm('确定要停止服务 ' + serviceName + ' 吗？')) {
            fetch('/api/monitoring/stop-service', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ service: serviceName })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateServicesStatus();
                    } else {
                        alert('停止服务失败: ' + data.message);
                    }
                });
        }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function () {
        initPerformanceChart();

        // 初始加载数据
        updatePerformanceData();
        updateServicesStatus();
        updateAlerts();
        updateRealtimeLogs();

        // 设置定时更新
        setInterval(updatePerformanceData, 5000);
        setInterval(updateServicesStatus, 10000);
        setInterval(updateAlerts, 30000);
        setInterval(updateRealtimeLogs, 2000);
    });
</script>
{% endblock %}