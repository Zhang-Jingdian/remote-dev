#!/bin/bash
# ğŸš€ è¿œç¨‹å¼€å‘ç¯å¢ƒç®¡ç†å·¥å…· v5.0
# ä½œè€…: Zhang-Jingdian (2157429750@qq.com)

set -e

# ================================================================================================
# é¢œè‰²å®šä¹‰
# ================================================================================================
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly GRAY='\033[0;90m'
readonly NC='\033[0m'

readonly SUCCESS="âœ…"
readonly ERROR="âŒ"
readonly INFO="â„¹ï¸"
readonly DOCKER="ğŸ³"
readonly SYNC="ğŸ“"
readonly ROCKET="ğŸš€"

# ================================================================================================
# é…ç½®ç®¡ç†
# ================================================================================================
load_config() {
    [[ -f "config.env" ]] || { echo -e "${RED}${ERROR} config.env æ–‡ä»¶ä¸å­˜åœ¨${NC}"; exit 1; }
    source config.env
}

# ================================================================================================
# ç”¨æˆ·ç•Œé¢
# ================================================================================================
print_header() {
    echo -e "${CYAN}${ROCKET} è¿œç¨‹å¼€å‘ç¯å¢ƒç®¡ç†å·¥å…· v5.0${NC}"
    echo -e "${GRAY}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

print_success() { echo -e "${GREEN}${SUCCESS} $1${NC}"; }
print_error() { echo -e "${RED}${ERROR} $1${NC}"; }
print_info() { echo -e "${BLUE}${INFO} $1${NC}"; }
print_docker() { echo -e "${CYAN}${DOCKER} $1${NC}"; }
print_sync() { echo -e "${YELLOW}${SYNC} $1${NC}"; }

show_help() {
    print_header
    echo
    echo -e "${YELLOW}ç”¨æ³•:${NC} ./dev <command>"
    echo
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  setup    åˆå§‹åŒ–ç¯å¢ƒ"
    echo "  dev      ä¸€é”®å¼€å‘æ¨¡å¼"
    echo "  up       å¯åŠ¨å®¹å™¨"
    echo "  down     åœæ­¢å®¹å™¨"
    echo "  remote   è¿›å…¥å®¹å™¨"
    echo "  sync     åŒæ­¥æ–‡ä»¶"
    echo "  status   æŸ¥çœ‹çŠ¶æ€"
    echo "  logs     æŸ¥çœ‹æ—¥å¿—"
    echo "  test     è¿è¡Œæµ‹è¯•"
    echo
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  ./dev setup    # åˆå§‹åŒ–"
    echo "  ./dev dev      # ä¸€é”®å¼€å‘"
    echo "  ./dev remote   # è¿›å…¥å®¹å™¨"
    echo
}

# ================================================================================================
# æ ¸å¿ƒåŠŸèƒ½
# ================================================================================================

# æ–‡ä»¶åŒæ­¥
sync_files() {
    print_sync "åŒæ­¥æ–‡ä»¶åˆ°è¿œç¨‹..."
    load_config
    
    local exclude_patterns=()
    if [[ -n "${SYNC_EXCLUDE}" ]]; then
        IFS=',' read -ra exclude_patterns <<< "${SYNC_EXCLUDE}"
    else
        exclude_patterns=('.git' 'node_modules' '__pycache__' '.venv' 'dist' '*.pyc' '*.log' '.DS_Store' '*.tmp' '.pytest_cache' 'coverage')
    fi
    
    local rsync_excludes=""
    for pattern in "${exclude_patterns[@]}"; do
        rsync_excludes="$rsync_excludes --exclude='$pattern'"
    done
    
    if eval rsync -av $rsync_excludes "./" "$REMOTE_HOST:$REMOTE_PATH/"; then
        print_success "æ–‡ä»¶åŒæ­¥å®Œæˆ"
    else
        print_error "æ–‡ä»¶åŒæ­¥å¤±è´¥"
        exit 1
    fi
}

# Dockerå®¹å™¨ç®¡ç†
docker_up() {
    print_docker "å¯åŠ¨Dockerå®¹å™¨..."
    load_config
    if docker-compose -f "${DOCKER_COMPOSE_FILE}" up -d; then
        print_success "Dockerå®¹å™¨å¯åŠ¨æˆåŠŸ"
        echo -e "${GRAY}ç«¯å£: ${DEBUG_PORT:-9000}, ${NODE_PORT:-3000}, ${PYTHON_PORT:-5000}, ${DJANGO_PORT:-8000}${NC}"
    else
        print_error "Dockerå®¹å™¨å¯åŠ¨å¤±è´¥"
        exit 1
    fi
}

docker_down() {
    print_docker "åœæ­¢Dockerå®¹å™¨..."
    load_config
    if docker-compose -f "${DOCKER_COMPOSE_FILE}" down; then
        print_success "Dockerå®¹å™¨åœæ­¢æˆåŠŸ"
    else
        print_error "Dockerå®¹å™¨åœæ­¢å¤±è´¥"
        exit 1
    fi
}

# çŠ¶æ€æ£€æŸ¥
show_status() {
    print_header
    echo
    
    load_config
    local docker_status=$(docker-compose -f "${DOCKER_COMPOSE_FILE}" ps 2>/dev/null || echo "")
    if echo "$docker_status" | grep -q "Up"; then
        print_docker "å®¹å™¨è¿è¡Œä¸­"
        echo "$docker_status" | grep -E "(NAME|${CONTAINER_NAME})" | sed 's/^/  /'
    else
        echo -e "${RED}${DOCKER} å®¹å™¨æœªè¿è¡Œ${NC}"
    fi
    
    echo
    if [[ -f "config.env" ]]; then
        print_success "é…ç½®æ–‡ä»¶å·²åŠ è½½"
        load_config
        echo -e "  ${GRAY}æœ¬åœ°è·¯å¾„:${NC} ${LOCAL_PATH:-'.'}"
        echo -e "  ${GRAY}è¿œç¨‹ä¸»æœº:${NC} ${REMOTE_HOST:-'localhost'}"
        echo -e "  ${GRAY}è¿œç¨‹è·¯å¾„:${NC} ${REMOTE_PATH:-'/tmp/workspace'}"
    else
        print_error "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
    fi
    
    echo
    if ping -c 1 "${REMOTE_HOST:-localhost}" >/dev/null 2>&1; then
        print_success "ç½‘ç»œè¿æ¥æ­£å¸¸"
    else
        echo -e "${RED}ç½‘ç»œè¿æ¥å¤±è´¥${NC}"
    fi
}

# æ—¥å¿—æŸ¥çœ‹
show_logs() {
    print_info "æ˜¾ç¤ºDockerå®¹å™¨æ—¥å¿— (Ctrl+C é€€å‡º)..."
    load_config
    docker-compose -f "${DOCKER_COMPOSE_FILE}" logs -f
}

# è¿œç¨‹å‘½ä»¤æ‰§è¡Œ
remote_run() {
    local command="$1"
    load_config
    
    if [[ -z "$command" ]]; then
        command="bash"
        print_info "å¯åŠ¨äº¤äº’å¼shell..."
    fi
    
    print_info "è¿æ¥åˆ° $REMOTE_HOST æ‰§è¡Œ: $command"
    sync_files
    
    if [[ "$command" == "bash" || "$command" == "sh" ]]; then
        local bashrc_file=".remote_bashrc"
        local interactive_command="cd $REMOTE_PATH && docker exec -it $CONTAINER_NAME bash -c \"
if [ -f /workspace/docker/$bashrc_file ]; then
    cp /workspace/docker/$bashrc_file /root/.bashrc
fi
cd /workspace
bash --login
\""
        ssh -t "$REMOTE_HOST" "$interactive_command"
    else
        local remote_command="cd $REMOTE_PATH && docker exec -i $CONTAINER_NAME $command"
        ssh "$REMOTE_HOST" "$remote_command"
    fi
}

# ç¯å¢ƒåˆå§‹åŒ–
setup_env() {
    print_header
    print_info "å¼€å§‹ç¯å¢ƒåˆå§‹åŒ–..."
    
    # ä¾èµ–æ£€æŸ¥
    print_info "æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
    local dependencies=("docker" "docker-compose" "rsync" "ssh")
    local missing_deps=()
    
    for dep in "${dependencies[@]}"; do
        if ! command -v "$dep" >/dev/null 2>&1; then
            missing_deps+=("$dep")
        fi
    done
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        print_error "ç¼ºå°‘ä¾èµ–: ${missing_deps[*]}"
        echo -e "${YELLOW}å®‰è£…å‘½ä»¤:${NC}"
        for dep in "${missing_deps[@]}"; do
            case "$dep" in
                "docker") echo "  è¯·å®‰è£… Docker Desktop" ;;
                "docker-compose") echo "  è¯·å®‰è£… Docker Compose" ;;
                *) echo "  è¯·å®‰è£… $dep" ;;
            esac
        done
        exit 1
    fi
    
    print_success "æ‰€æœ‰ä¾èµ–å·²å®‰è£…"
    
    # é…ç½®æ–‡ä»¶æ£€æŸ¥
    if [[ ! -f "config.env" ]]; then
        print_info "åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶..."
        cat > config.env << 'EOF'
# è¿œç¨‹æœåŠ¡å™¨é…ç½®
REMOTE_HOST=192.168.0.105
REMOTE_USER=zjd
REMOTE_PATH=/home/zjd/workspace

# æœ¬åœ°é…ç½®
LOCAL_PATH=./work

# åŒæ­¥é…ç½®
SYNC_EXCLUDE=".git,node_modules,*.log,*.tmp,.DS_Store,__pycache__"

# å¼€å‘å·¥å…·é…ç½®
DEV_SCRIPT=./dev
DOCKER_DIR=./docker
LOGS_DIR=./docker/logs

# Dockeré…ç½®
CONTAINER_NAME=remote-dev-env
DOCKER_COMPOSE_FILE=./docker/docker-compose.yml

# å¼€å‘ç¯å¢ƒé…ç½®
PYTHON_VERSION=3.11
NODE_VERSION=18

# ç«¯å£é…ç½®
PYTHON_PORT=5000
NODE_PORT=3000
DJANGO_PORT=8000
DEBUG_PORT=9000

# æ€§èƒ½é…ç½®
SYNC_INTERVAL=5
WATCH_ENABLED=true
AUTO_SYNC=true

# ä»£ç†é…ç½®
HTTP_PROXY=socks5://127.0.0.1:7897
HTTPS_PROXY=socks5://127.0.0.1:7897
NO_PROXY=localhost,127.0.0.1
EOF
        print_success "é…ç½®æ–‡ä»¶å·²åˆ›å»º: config.env"
    else
        print_success "é…ç½®æ–‡ä»¶å·²å­˜åœ¨"
    fi
    
    # å®‰è£…å‘½ä»¤åˆ«å
    print_info "å®‰è£…devå‘½ä»¤åˆ«å..."
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local dev_script="${DEV_SCRIPT:-$script_dir/dev}"
    
    if [[ ! -x "$dev_script" ]]; then
        chmod +x "$dev_script"
    fi
    
    if [[ -w "/usr/local/bin" ]]; then
        ln -sf "$dev_script" "/usr/local/bin/dev" 2>/dev/null
        print_success "devå‘½ä»¤å·²å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„"
        echo -e "${GRAY}ğŸ’¡ ç°åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨ 'dev' å‘½ä»¤${NC}"
    else
        local shell_config=""
        if [[ "$SHELL" == *"zsh"* ]]; then
            shell_config="$HOME/.zshrc"
        elif [[ "$SHELL" == *"bash"* ]]; then
            shell_config="$HOME/.bashrc"
            [[ -f "$HOME/.bash_profile" ]] && shell_config="$HOME/.bash_profile"
        fi
        
        if [[ -n "$shell_config" ]]; then
            if ! grep -q "alias dev=" "$shell_config" 2>/dev/null; then
                echo "" >> "$shell_config"
                echo "# devå‘½ä»¤åˆ«å - è¿œç¨‹å¼€å‘ç¯å¢ƒ" >> "$shell_config"
                echo "alias dev='$dev_script'" >> "$shell_config"
                print_success "åˆ«åå·²æ·»åŠ åˆ° $shell_config"
                echo -e "${YELLOW}ğŸ’¡ è¯·è¿è¡Œ 'source $shell_config' æˆ–é‡æ–°æ‰“å¼€ç»ˆç«¯${NC}"
            else
                print_success "devåˆ«åå·²å­˜åœ¨"
            fi
        else
            print_info "æ— æ³•è‡ªåŠ¨è®¾ç½®åˆ«åï¼Œè¯·æ‰‹åŠ¨æ·»åŠ :"
            echo "   alias dev='$dev_script'"
        fi
    fi
    
    echo
    print_success "ğŸ‰ ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼"
    
    # è¿è¡Œç³»ç»Ÿæµ‹è¯•
    echo
    print_info "è¿è¡Œç³»ç»Ÿæµ‹è¯•..."
    run_tests
    
    echo
    echo -e "${YELLOW}ğŸš€ ä¸‹ä¸€æ­¥:${NC}"
    echo "  1. å¯åŠ¨ç¯å¢ƒ: dev up (æˆ– ./dev up)"
    echo "  2. è¿›å…¥å¼€å‘: dev remote bash"
    echo "  3. ç¼–è¾‘é…ç½®æ–‡ä»¶: vim config.env (å¯é€‰)"
}

# ä¸€é”®å¼€å‘æ¨¡å¼
dev_mode() {
    print_header
    print_info "ğŸš€ å¯åŠ¨ä¸€é”®å¼€å‘æ¨¡å¼..."
    
    docker_up
    sync_files
    detect_and_install_deps
    print_info "è¿›å…¥å¼€å‘ç¯å¢ƒ..."
    remote_run "bash"
}

# æ™ºèƒ½ä¾èµ–æ£€æµ‹å’Œå®‰è£…
detect_and_install_deps() {
    print_info "ğŸ” æ£€æµ‹é¡¹ç›®ç±»å‹..."
    
    local has_python=false
    local has_node=false
    
    if [[ -f "requirements.txt" ]] || [[ -f "pyproject.toml" ]] || [[ -f "setup.py" ]]; then
        has_python=true
        print_info "æ£€æµ‹åˆ°Pythoné¡¹ç›®"
    fi
    
    if [[ -f "package.json" ]]; then
        has_node=true
        print_info "æ£€æµ‹åˆ°Node.jsé¡¹ç›®"
    fi
    
    if [[ "$has_python" == "true" ]]; then
        print_info "å®‰è£…Pythonä¾èµ–..."
        remote_run "pip install -r requirements.txt 2>/dev/null || echo 'Pythonä¾èµ–å®‰è£…å®Œæˆ'"
    fi
    
    if [[ "$has_node" == "true" ]]; then
        print_info "å®‰è£…Node.jsä¾èµ–..."
        remote_run "npm install 2>/dev/null || echo 'Node.jsä¾èµ–å®‰è£…å®Œæˆ'"
    fi
}

# ç³»ç»Ÿæµ‹è¯•
run_tests() {
    print_info "è¿è¡Œç³»ç»Ÿæµ‹è¯•..."
    
    local tests_total=0
    local tests_passed=0
    local tests_failed=0
    
    run_test() {
        local test_name="$1"
        local test_func="$2"
        ((tests_total++))
        
        if $test_func; then
            print_success "$test_name"
            ((tests_passed++))
        else
            print_error "$test_nameå¤±è´¥"
            ((tests_failed++))
        fi
    }
    
    test_config_exists() { [[ -f "config.env" ]]; }
    test_dev_executable() { [[ -f "dev" ]] && [[ -x "dev" ]]; }
    test_docker_files() { [[ -f "docker/docker-compose.yml" ]]; }
    test_bashrc() { [[ -f "docker/.remote_bashrc" ]]; }
    test_basic_deps() {
        local deps=("docker" "rsync" "ssh")
        for dep in "${deps[@]}"; do
            command -v "$dep" >/dev/null 2>&1 || return 1
        done
        return 0
    }
    test_syntax() { bash -n "./dev" 2>/dev/null; }
    test_network() {
        if [[ -f "config.env" ]]; then
            load_config
            ping -c 1 "${REMOTE_HOST:-localhost}" >/dev/null 2>&1
        else
            return 0
        fi
    }
    
    echo -e "${BLUE}ğŸ§ª å¼€å§‹è¿è¡Œç³»ç»Ÿæµ‹è¯•...${NC}"
    echo "$(printf '=%.0s' {1..40})"
    
    run_test "é…ç½®æ–‡ä»¶å­˜åœ¨" test_config_exists || true
    run_test "devè„šæœ¬å¯æ‰§è¡Œ" test_dev_executable || true
    run_test "Dockeré…ç½®æ–‡ä»¶å­˜åœ¨" test_docker_files || true
    run_test "bashrcé…ç½®å­˜åœ¨" test_bashrc || true
    run_test "åŸºç¡€ä¾èµ–æ£€æŸ¥" test_basic_deps || true
    run_test "devè„šæœ¬è¯­æ³•æ­£ç¡®" test_syntax || true
    run_test "ç½‘ç»œè¿æ¥æ­£å¸¸" test_network || true
    
    echo "$(printf '=%.0s' {1..40})"
    
    if [[ $tests_failed -eq 0 ]]; then
        print_success "æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼($tests_passed/$tests_total)"
        echo -e "${BLUE}ğŸ’¡ è¿œç¨‹å¼€å‘ç¯å¢ƒå·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨äº†${NC}"
        return 0
    else
        print_error "$tests_failed ä¸ªæµ‹è¯•å¤±è´¥ (æ€»è®¡ $tests_total ä¸ªæµ‹è¯•)"
        echo -e "${GREEN}âœ… $tests_passed ä¸ªæµ‹è¯•é€šè¿‡${NC}"
        return 1
    fi
}

# ================================================================================================
# ä¸»ç¨‹åºå…¥å£
# ================================================================================================
main() {
    case "${1:-help}" in
        setup)      setup_env ;;
        sync)       sync_files ;;
        up)         docker_up ;;
        down)       docker_down ;;
        status)     show_status ;;
        logs)       show_logs ;;
        remote)     remote_run "$2" ;;
        dev)        dev_mode ;;
        test)       run_tests ;;
        help|*)     show_help ;;
    esac
}

# æ‰§è¡Œä¸»ç¨‹åº
main "$@" 