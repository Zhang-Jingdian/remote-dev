#!/bin/bash
# ğŸš€ è¿œç¨‹å¼€å‘ç¯å¢ƒç®¡ç†å·¥å…·
# ä½œè€…: Zhang-Jingdian (2157429750@qq.com)
# ç‰ˆæœ¬: v4.0

set -e

# ================================================================================================
# é¢œè‰²å’Œå›¾æ ‡å®šä¹‰
# ================================================================================================
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly GRAY='\033[0;90m'
readonly NC='\033[0m'

readonly SUCCESS="âœ…"
readonly ERROR="âŒ"
readonly INFO="â„¹ï¸"
readonly DOCKER="ğŸ³"
readonly SYNC="ğŸ“"
readonly ROCKET="ğŸš€"
readonly CONFIG="âš™ï¸"
readonly NETWORK="ğŸŒ"

# ================================================================================================
# é…ç½®ç®¡ç†
# ================================================================================================
load_config() {
    [[ -f "config.env" ]] || { echo -e "${RED}${ERROR} config.env æ–‡ä»¶ä¸å­˜åœ¨${NC}"; exit 1; }
    source config.env
}

# ================================================================================================
# ç”¨æˆ·ç•Œé¢ - ç²¾ç®€ç¾è§‚çš„è¾“å‡º
# ================================================================================================
print_header() {
    echo -e "${CYAN}${ROCKET} è¿œç¨‹å¼€å‘ç¯å¢ƒç®¡ç†å·¥å…· v4.0${NC}"
    echo -e "${GRAY}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

print_success() { echo -e "${GREEN}${SUCCESS} $1${NC}"; }
print_error() { echo -e "${RED}${ERROR} $1${NC}"; }
print_info() { echo -e "${BLUE}${INFO} $1${NC}"; }
print_docker() { echo -e "${CYAN}${DOCKER} $1${NC}"; }
print_sync() { echo -e "${YELLOW}${SYNC} $1${NC}"; }

show_help() {
    print_header
    echo
    echo -e "${YELLOW}ç”¨æ³•:${NC} ./dev <command> [options]"
    echo
    echo -e "${YELLOW}æ ¸å¿ƒå‘½ä»¤:${NC}"
    echo "  setup       åˆå§‹åŒ–ç¯å¢ƒ"
    echo "  sync        åŒæ­¥æ–‡ä»¶åˆ°è¿œç¨‹"
    echo "  up          å¯åŠ¨Dockerå®¹å™¨"
    echo "  down        åœæ­¢Dockerå®¹å™¨"
    echo "  status      æŸ¥çœ‹è¿è¡ŒçŠ¶æ€"
    echo "  logs        æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "  remote-run  åœ¨è¿œç¨‹å®¹å™¨æ‰§è¡Œå‘½ä»¤"
    echo
    echo -e "${YELLOW}å¼€å‘å‘½ä»¤:${NC}"
    echo "  watch       ç›‘æ§æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨åŒæ­¥"
    echo "  web         å¯åŠ¨Webç®¡ç†ç•Œé¢"
    echo "  test        è¿è¡Œç³»ç»Ÿæµ‹è¯•"
    echo
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  ./dev up                    # å¯åŠ¨ç¯å¢ƒ"
    echo "  ./dev remote-run bash       # è¿›å…¥äº¤äº’å¼shell"
    echo "  ./dev remote-run 'ls -la'   # æ‰§è¡Œå‘½ä»¤"
    echo
}

# ================================================================================================
# æ ¸å¿ƒåŠŸèƒ½ - ä¼˜åŒ–ç®—æ³•å’Œæ•°æ®ç»“æ„
# ================================================================================================

# æ–‡ä»¶åŒæ­¥ - ä¼˜åŒ–åŒæ­¥ç­–ç•¥
sync_files() {
    print_sync "åŒæ­¥æ–‡ä»¶åˆ°è¿œç¨‹..."
    load_config
    
    local local_path=${LOCAL_PATH:-"."}
    local remote_path=${REMOTE_PATH:-"/tmp/workspace"}
    local remote_host=${REMOTE_HOST:-"localhost"}
    
    # ä¼˜åŒ–çš„æ’é™¤æ¨¡å¼ - å‡å°‘ä¸å¿…è¦çš„æ–‡ä»¶ä¼ è¾“
    local exclude_patterns=(
        '.git' 'node_modules' '__pycache__' '.venv' 
        'dist' '*.pyc' '*.log' '.DS_Store' 
        '*.tmp' '.pytest_cache' 'coverage'
    )
    
    local rsync_excludes=""
    for pattern in "${exclude_patterns[@]}"; do
        rsync_excludes="$rsync_excludes --exclude='$pattern'"
    done
    
    if eval rsync -av $rsync_excludes "./" "$remote_host:$remote_path/"; then
        print_success "æ–‡ä»¶åŒæ­¥å®Œæˆ"
    else
        print_error "æ–‡ä»¶åŒæ­¥å¤±è´¥"
        exit 1
    fi
}

# Dockerå®¹å™¨ç®¡ç† - ç²¾ç®€çš„å®¹å™¨æ“ä½œ
docker_up() {
    print_docker "å¯åŠ¨Dockerå®¹å™¨..."
    if docker-compose -f docker/docker-compose.yml up -d; then
        print_success "Dockerå®¹å™¨å¯åŠ¨æˆåŠŸ"
        echo -e "${GRAY}ç«¯å£æ˜ å°„: 8080(Web) 9000(API)${NC}"
    else
        print_error "Dockerå®¹å™¨å¯åŠ¨å¤±è´¥"
        exit 1
    fi
}

docker_down() {
    print_docker "åœæ­¢Dockerå®¹å™¨..."
    if docker-compose -f docker/docker-compose.yml down; then
        print_success "Dockerå®¹å™¨åœæ­¢æˆåŠŸ"
    else
        print_error "Dockerå®¹å™¨åœæ­¢å¤±è´¥"
        exit 1
    fi
}

# çŠ¶æ€æ£€æŸ¥ - ä¼˜åŒ–çŠ¶æ€æ˜¾ç¤º
show_status() {
    print_header
    echo
    
    # DockerçŠ¶æ€æ£€æŸ¥
    local docker_status=$(docker-compose -f docker/docker-compose.yml ps 2>/dev/null || echo "")
    if echo "$docker_status" | grep -q "Up"; then
        print_docker "å®¹å™¨è¿è¡Œä¸­"
        echo "$docker_status" | grep -E "(NAME|remote-dev-env)" | sed 's/^/  /'
    else
        echo -e "${RED}${DOCKER} å®¹å™¨æœªè¿è¡Œ${NC}"
        local containers=$(docker ps -a --filter "name=remote-dev-env" --format "table {{.Names}}\t{{.Status}}" 2>/dev/null | grep -v NAMES)
        [[ -n "$containers" ]] && echo "$containers" | sed 's/^/  /'
    fi
    
    echo
    
    # é…ç½®çŠ¶æ€
    if [[ -f "config.env" ]]; then
        print_success "é…ç½®æ–‡ä»¶å·²åŠ è½½"
        load_config
        echo -e "  ${GRAY}æœ¬åœ°è·¯å¾„:${NC} ${LOCAL_PATH:-'.'}"
        echo -e "  ${GRAY}è¿œç¨‹ä¸»æœº:${NC} ${REMOTE_HOST:-'localhost'}"
        echo -e "  ${GRAY}è¿œç¨‹è·¯å¾„:${NC} ${REMOTE_PATH:-'/tmp/workspace'}"
    else
        print_error "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
    fi
    
    echo
    
    # ç½‘ç»œè¿é€šæ€§æ£€æŸ¥ï¼ˆå¿«é€Ÿï¼‰
    if ping -c 1 "${REMOTE_HOST:-localhost}" >/dev/null 2>&1; then
        print_success "ç½‘ç»œè¿æ¥æ­£å¸¸"
    else
        echo -e "${RED}${NETWORK} ç½‘ç»œè¿æ¥å¤±è´¥${NC}"
    fi
}

# æ—¥å¿—æŸ¥çœ‹ - ç®€åŒ–æ—¥å¿—è¾“å‡º
show_logs() {
    print_info "æ˜¾ç¤ºDockerå®¹å™¨æ—¥å¿— (Ctrl+C é€€å‡º)..."
    docker-compose -f docker/docker-compose.yml logs -f
}

# è¿œç¨‹å‘½ä»¤æ‰§è¡Œ - ä¼˜åŒ–äº¤äº’ä½“éªŒ
remote_run() {
    local command="$1"
    
    load_config
    local remote_host=${REMOTE_HOST:-"localhost"}
    local remote_path=${REMOTE_PATH:-"/tmp/workspace"}
    local container_name="remote-dev-env"
    
    if [[ -z "$command" ]]; then
        command="bash"
        print_info "å¯åŠ¨äº¤äº’å¼shell..."
    fi
    
    print_info "è¿æ¥åˆ° $remote_host æ‰§è¡Œ: $command"
    
    # å…ˆåŒæ­¥æœ€æ–°ä»£ç 
    sync_files
    
    if [[ "$command" == "bash" || "$command" == "sh" ]]; then
        # äº¤äº’å¼shellé…ç½®
        local bashrc_file=".remote_bashrc_simple"  # é»˜è®¤ä½¿ç”¨ç®€åŒ–ç‰ˆ
        
        if [[ -t 0 ]]; then
            echo -e "${YELLOW}é€‰æ‹©æç¤ºç¬¦æ ·å¼: [1] å®Œæ•´ç‰ˆ [2] ç®€åŒ–ç‰ˆ (é»˜è®¤: 2)${NC}"
            read -t 3 -p "è¯·é€‰æ‹©: " prompt_choice
            [[ "$prompt_choice" == "1" ]] && bashrc_file=".remote_bashrc"
        fi
        
        local interactive_command="cd $remote_path && docker exec -it $container_name bash -c \"
if [ -f /workspace/docker/$bashrc_file ]; then
    cp /workspace/docker/$bashrc_file /root/.bashrc
fi
cd /workspace
bash --login
\""
        ssh -t "$remote_host" "$interactive_command"
    else
        # éäº¤äº’å¼å‘½ä»¤
        local remote_command="cd $remote_path && docker exec -i $container_name $command"
        ssh "$remote_host" "$remote_command"
    fi
}

# ç¯å¢ƒåˆå§‹åŒ– - ä¼˜åŒ–å®‰è£…æ£€æŸ¥
setup_env() {
    print_header
    print_info "æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
    
    # ä¾èµ–æ£€æŸ¥æ•°ç»„
    local dependencies=("docker" "docker-compose" "rsync" "ssh")
    local missing_deps=()
    
    for dep in "${dependencies[@]}"; do
        if ! command -v "$dep" >/dev/null 2>&1; then
            missing_deps+=("$dep")
        fi
    done
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        print_error "ç¼ºå°‘ä¾èµ–: ${missing_deps[*]}"
        exit 1
    fi
    
    print_success "æ‰€æœ‰ä¾èµ–å·²å®‰è£…"
    
    # é…ç½®æ–‡ä»¶æ£€æŸ¥
    if [[ ! -f "config.env" ]]; then
        print_info "åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶..."
        cat > config.env << 'EOF'
# è¿œç¨‹æœåŠ¡å™¨é…ç½®
REMOTE_HOST=192.168.0.105
REMOTE_USER=zjd
REMOTE_PATH=/home/zjd/workspace

# æœ¬åœ°é…ç½®
LOCAL_PATH=./work

# åŒæ­¥é…ç½®
SYNC_EXCLUDE=".git,node_modules,*.log,*.tmp,.DS_Store,__pycache__"
EOF
        print_success "é…ç½®æ–‡ä»¶å·²åˆ›å»º: config.env"
    fi
    
    print_success "ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
}

# æ–‡ä»¶ç›‘æ§ - ä¼˜åŒ–ç›‘æ§ç®—æ³•
watch_files() {
    print_info "å¯åŠ¨æ–‡ä»¶ç›‘æ§..."
    
    if ! command -v fswatch >/dev/null 2>&1; then
        print_error "éœ€è¦å®‰è£… fswatch: brew install fswatch"
        exit 1
    fi
    
    local watch_path=${LOCAL_PATH:-"."}
    print_info "ç›‘æ§ç›®å½•: $watch_path"
    
    fswatch -o "$watch_path" --exclude="\.git" --exclude="node_modules" --exclude="__pycache__" | while read -r
    do
        echo -e "${YELLOW}$(date '+%H:%M:%S')${NC} æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œæ­£åœ¨åŒæ­¥..."
        sync_files
    done
}

# Webç•Œé¢å¯åŠ¨
start_web() {
    print_info "å¯åŠ¨Webç®¡ç†ç•Œé¢..."
    
    # å¯åŠ¨åç«¯API
    if [[ -f "main.py" ]]; then
        print_info "å¯åŠ¨åç«¯APIæœåŠ¡ (ç«¯å£ 9000)..."
        python3 main.py &
        local api_pid=$!
    fi
    
    # å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
    if [[ -d "web" ]]; then
        print_info "å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨ (ç«¯å£ 3000)..."
        cd web && npm run dev &
        local web_pid=$!
        cd ..
    fi
    
    print_success "Webç•Œé¢å·²å¯åŠ¨"
    echo -e "${GRAY}API: http://localhost:9000${NC}"
    echo -e "${GRAY}Web: http://localhost:3000${NC}"
    echo -e "${YELLOW}æŒ‰ Ctrl+C åœæ­¢æœåŠ¡${NC}"
    
    # ç­‰å¾…ç”¨æˆ·ä¸­æ–­
    trap 'kill $api_pid $web_pid 2>/dev/null; print_info "æœåŠ¡å·²åœæ­¢"; exit 0' INT
    wait
}

# ç³»ç»Ÿæµ‹è¯•
run_tests() {
    print_info "è¿è¡Œç³»ç»Ÿæµ‹è¯•..."
    
    # åŸºç¡€è¿é€šæ€§æµ‹è¯•
    if [[ -f "config.env" ]]; then
        load_config
        if ping -c 1 "$REMOTE_HOST" >/dev/null 2>&1; then
            print_success "ç½‘ç»œè¿é€šæ€§æµ‹è¯•é€šè¿‡"
        else
            print_error "ç½‘ç»œè¿é€šæ€§æµ‹è¯•å¤±è´¥"
            return 1
        fi
    fi
    
    # Dockeræµ‹è¯•
    if docker --version >/dev/null 2>&1; then
        print_success "Dockeræµ‹è¯•é€šè¿‡"
    else
        print_error "Dockeræµ‹è¯•å¤±è´¥"
        return 1
    fi
    
    print_success "æ‰€æœ‰æµ‹è¯•é€šè¿‡"
}

# ================================================================================================
# ä¸»ç¨‹åºå…¥å£ - ä¼˜åŒ–å‘½ä»¤è·¯ç”±
# ================================================================================================
main() {
    case "${1:-help}" in
        setup)      setup_env ;;
        sync)       sync_files ;;
        watch)      watch_files ;;
        up)         docker_up ;;
        down)       docker_down ;;
        status)     show_status ;;
        logs)       show_logs ;;
        remote-run) remote_run "$2" ;;
        web)        start_web ;;
        test)       run_tests ;;
        help|*)     show_help ;;
    esac
}

# æ‰§è¡Œä¸»ç¨‹åº
main "$@" 