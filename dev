#!/bin/bash
# ğŸš€ è¿œç¨‹å¼€å‘ç¯å¢ƒ - ç®€åŒ–CLIå·¥å…·
# ä½œè€…: Zhang-Jingdian (2157429750@qq.com)

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# åŠ è½½é…ç½®
load_config() {
    if [[ -f "config.env" ]]; then
        source config.env
    else
        echo -e "${RED}âŒ config.env æ–‡ä»¶ä¸å­˜åœ¨${NC}"
        exit 1
    fi
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    echo "ğŸš€ è¿œç¨‹å¼€å‘ç¯å¢ƒ - ç®€åŒ–CLIå·¥å…·"
    echo
    echo "ç”¨æ³•: ./dev <command> [options]"
    echo
    echo "å‘½ä»¤:"
    echo "  setup      åˆå§‹åŒ–ç¯å¢ƒ"
    echo "  sync       åŒæ­¥æ–‡ä»¶åˆ°è¿œç¨‹"
    echo "  watch      ç›‘æ§æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨åŒæ­¥"
    echo "  up         å¯åŠ¨Dockerå®¹å™¨"
    echo "  down       åœæ­¢Dockerå®¹å™¨"
    echo "  status     æŸ¥çœ‹è¿è¡ŒçŠ¶æ€"
    echo "  logs       æŸ¥çœ‹æ—¥å¿—"
    echo "  test       è¿è¡Œæµ‹è¯•"
    echo "  remote-run åœ¨è¿œç¨‹Dockerå®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤"
    echo "  help       æ˜¾ç¤ºå¸®åŠ©"
    echo
}

# åˆå§‹åŒ–ç¯å¢ƒ
setup_env() {
    echo -e "${BLUE}ğŸ”§ åˆå§‹åŒ–ç¯å¢ƒ...${NC}"
    
    # æ£€æŸ¥ä¾èµ–
    command -v docker >/dev/null 2>&1 || { echo -e "${RED}âŒ Docker æœªå®‰è£…${NC}"; exit 1; }
    command -v rsync >/dev/null 2>&1 || { echo -e "${RED}âŒ rsync æœªå®‰è£…${NC}"; exit 1; }
    
    # åˆ›å»ºå¿…è¦ç›®å½•
    mkdir -p logs
    
    echo -e "${GREEN}âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ${NC}"
}

# æ–‡ä»¶åŒæ­¥
sync_files() {
    echo -e "${BLUE}ğŸ“ åŒæ­¥æ–‡ä»¶åˆ°è¿œç¨‹...${NC}"
    load_config
    
    local local_path=${LOCAL_PATH:-"."}
    local remote_path=${REMOTE_PATH:-"/tmp/workspace"}
    local remote_host=${REMOTE_HOST:-"localhost"}
    
    if rsync -av --exclude='.git' --exclude='node_modules' --exclude='__pycache__' \
              "$local_path/" "$remote_host:$remote_path/"; then
        echo -e "${GREEN}âœ… æ–‡ä»¶åŒæ­¥æˆåŠŸ${NC}"
    else
        echo -e "${RED}âŒ æ–‡ä»¶åŒæ­¥å¤±è´¥${NC}"
        exit 1
    fi
}

# ç›‘æ§æ–‡ä»¶å˜åŒ–
watch_files() {
    echo -e "${BLUE}ğŸ‘ï¸  å¼€å§‹ç›‘æ§æ–‡ä»¶å˜åŒ–...${NC}"
    
    if command -v fswatch >/dev/null 2>&1; then
        # macOSä½¿ç”¨fswatch
        fswatch -o . | while read f; do
            echo -e "${YELLOW}ğŸ”„ æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œæ­£åœ¨åŒæ­¥...${NC}"
            sync_files
        done
    elif command -v inotifywait >/dev/null 2>&1; then
        # Linuxä½¿ç”¨inotifywait
        inotifywait -mr --format '%w%f' -e modify,create,delete . | while read file; do
            echo -e "${YELLOW}ğŸ”„ æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–: $file${NC}"
            sync_files
        done
    else
        echo -e "${YELLOW}âš ï¸  æ–‡ä»¶ç›‘æ§å·¥å…·æœªå®‰è£…ï¼Œä½¿ç”¨å®šæ—¶åŒæ­¥...${NC}"
        while true; do
            sleep 5
            sync_files
        done
    fi
}

# Dockeræ“ä½œ
docker_up() {
    echo -e "${BLUE}ğŸ³ å¯åŠ¨Dockerå®¹å™¨...${NC}"
    if docker-compose up -d; then
        echo -e "${GREEN}âœ… Dockerå®¹å™¨å¯åŠ¨æˆåŠŸ${NC}"
    else
        echo -e "${RED}âŒ Dockerå®¹å™¨å¯åŠ¨å¤±è´¥${NC}"
        exit 1
    fi
}

docker_down() {
    echo -e "${BLUE}ğŸ³ åœæ­¢Dockerå®¹å™¨...${NC}"
    if docker-compose down; then
        echo -e "${GREEN}âœ… Dockerå®¹å™¨åœæ­¢æˆåŠŸ${NC}"
    else
        echo -e "${RED}âŒ Dockerå®¹å™¨åœæ­¢å¤±è´¥${NC}"
        exit 1
    fi
}

# åœ¨è¿œç¨‹Dockerå®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤
remote_run() {
    echo -e "${BLUE}ğŸš€ åœ¨è¿œç¨‹Dockerå®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤...${NC}"
    load_config
    
    local remote_host=${REMOTE_HOST:-"localhost"}
    local remote_path=${REMOTE_PATH:-"/tmp/workspace"}
    local container_name=${DOCKER_SERVICE_NAME:-"dev-env"}
    
    # è·å–è¦æ‰§è¡Œçš„å‘½ä»¤
    local command="${*:1}"  # è·å–æ‰€æœ‰å‚æ•°ä½œä¸ºå‘½ä»¤
    
    if [[ -z "$command" ]]; then
        command="bash"  # é»˜è®¤è¿›å…¥bash
        echo -e "${YELLOW}ğŸ’¡ æœªæŒ‡å®šå‘½ä»¤ï¼Œå°†è¿›å…¥äº¤äº’å¼shell${NC}"
    fi
    
    echo -e "${BLUE}ğŸ“¡ è¿æ¥åˆ° $remote_host æ‰§è¡Œ: $command${NC}"
    
    # å…ˆåŒæ­¥æœ€æ–°ä»£ç 
    sync_files
    
    # åœ¨è¿œç¨‹Dockerå®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤
    ssh "$remote_host" "cd $remote_path && docker exec -it $container_name $command"
}

# æŸ¥çœ‹çŠ¶æ€
show_status() {
    echo -e "${BLUE}ğŸ“Š ç³»ç»ŸçŠ¶æ€:${NC}"
    echo
    
    # DockerçŠ¶æ€
    if docker-compose ps >/dev/null 2>&1; then
        echo -e "${GREEN}ğŸ³ Docker: è¿è¡Œä¸­${NC}"
        docker-compose ps
    else
        echo -e "${RED}ğŸ³ Docker: æœªè¿è¡Œ${NC}"
    fi
    
    echo
    
    # é…ç½®çŠ¶æ€
    if [[ -f "config.env" ]]; then
        echo -e "${GREEN}âš™ï¸  é…ç½®æ–‡ä»¶: å­˜åœ¨${NC}"
        load_config
        echo "   æœ¬åœ°è·¯å¾„: ${LOCAL_PATH:-'.'}"
        echo "   è¿œç¨‹ä¸»æœº: ${REMOTE_HOST:-'localhost'}"
        echo "   è¿œç¨‹è·¯å¾„: ${REMOTE_PATH:-'/tmp/workspace'}"
    else
        echo -e "${RED}âš™ï¸  é…ç½®æ–‡ä»¶: ä¸å­˜åœ¨${NC}"
    fi
    
    echo
    
    # è¿æ¥æµ‹è¯•
    load_config
    if ping -c 1 "${REMOTE_HOST:-localhost}" >/dev/null 2>&1; then
        echo -e "${GREEN}ğŸŒ ç½‘ç»œè¿æ¥: æ­£å¸¸${NC}"
    else
        echo -e "${RED}ğŸŒ ç½‘ç»œè¿æ¥: å¤±è´¥${NC}"
    fi
}

# æŸ¥çœ‹æ—¥å¿—
show_logs() {
    local lines=${1:-50}
    echo -e "${BLUE}ğŸ“‹ Dockeræ—¥å¿— (æœ€è¿‘ $lines è¡Œ):${NC}"
    docker-compose logs --tail="$lines" -f
}

# è¿è¡Œæµ‹è¯•
run_tests() {
    echo -e "${BLUE}ğŸ§ª è¿è¡Œæµ‹è¯•...${NC}"
    if python3 tests/test_dev.py; then
        echo -e "${GREEN}âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡${NC}"
    else
        echo -e "${RED}âŒ æµ‹è¯•å¤±è´¥${NC}"
        exit 1
    fi
}

# ä¸»å‘½ä»¤å¤„ç†
main() {
    case "${1:-help}" in
        setup)
            setup_env
            ;;
        sync)
            sync_files
            ;;
        watch)
            watch_files
            ;;
        up)
            docker_up
            ;;
        down)
            docker_down
            ;;
        status)
            show_status
            ;;
        logs)
            show_logs "${2:-50}"
            ;;
        test)
            run_tests
            ;;
        remote-run)
            shift  # ç§»é™¤ç¬¬ä¸€ä¸ªå‚æ•°(remote-run)
            remote_run "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}âŒ æœªçŸ¥å‘½ä»¤: $1${NC}"
            echo
            show_help
            exit 1
            ;;
    esac
}

main "$@" 