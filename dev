#!/bin/bash
# ğŸš€ è¿œç¨‹å¼€å‘ç¯å¢ƒç®¡ç†å·¥å…·
# ä½œè€…: Zhang-Jingdian (2157429750@qq.com)
# ç‰ˆæœ¬: v4.0

set -e

# ================================================================================================
# é¢œè‰²å’Œå›¾æ ‡å®šä¹‰
# ================================================================================================
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly GRAY='\033[0;90m'
readonly NC='\033[0m'

readonly SUCCESS="âœ…"
readonly ERROR="âŒ"
readonly INFO="â„¹ï¸"
readonly DOCKER="ğŸ³"
readonly SYNC="ğŸ“"
readonly ROCKET="ğŸš€"
readonly CONFIG="âš™ï¸"
readonly NETWORK="ğŸŒ"

# ================================================================================================
# é…ç½®ç®¡ç†
# ================================================================================================
load_config() {
    [[ -f "config.env" ]] || { echo -e "${RED}${ERROR} config.env æ–‡ä»¶ä¸å­˜åœ¨${NC}"; exit 1; }
    source config.env
}

# ================================================================================================
# ç”¨æˆ·ç•Œé¢ - ç²¾ç®€ç¾è§‚çš„è¾“å‡º
# ================================================================================================
print_header() {
    echo -e "${CYAN}${ROCKET} è¿œç¨‹å¼€å‘ç¯å¢ƒç®¡ç†å·¥å…· v4.0${NC}"
    echo -e "${GRAY}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

print_success() { echo -e "${GREEN}${SUCCESS} $1${NC}"; }
print_error() { echo -e "${RED}${ERROR} $1${NC}"; }
print_info() { echo -e "${BLUE}${INFO} $1${NC}"; }
print_docker() { echo -e "${CYAN}${DOCKER} $1${NC}"; }
print_sync() { echo -e "${YELLOW}${SYNC} $1${NC}"; }

show_help() {
    print_header
    echo
    echo -e "${YELLOW}ç”¨æ³•:${NC} ./dev <command> [options]"
    echo
    echo -e "${YELLOW}æ ¸å¿ƒå‘½ä»¤:${NC}"
    echo "  setup       åˆå§‹åŒ–ç¯å¢ƒ"
    echo "  sync        åŒæ­¥æ–‡ä»¶åˆ°è¿œç¨‹"
    echo "  up          å¯åŠ¨Dockerå®¹å™¨"
    echo "  down        åœæ­¢Dockerå®¹å™¨"
    echo "  status      æŸ¥çœ‹è¿è¡ŒçŠ¶æ€"
    echo "  logs        æŸ¥çœ‹å®æ—¶æ—¥å¿—"
    echo "  remote      åœ¨è¿œç¨‹å®¹å™¨æ‰§è¡Œå‘½ä»¤ (åˆ«å: remote-run, run)"
    echo
    echo -e "${YELLOW}å¼€å‘å‘½ä»¤:${NC}"
    echo "  watch       ç›‘æ§æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨åŒæ­¥"
    echo
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  ./dev up                    # å¯åŠ¨ç¯å¢ƒ"
    echo "  ./dev remote bash           # è¿›å…¥äº¤äº’å¼shell"
    echo "  ./dev run 'ls -la'          # æ‰§è¡Œå‘½ä»¤"
    echo
}

# ================================================================================================
# æ ¸å¿ƒåŠŸèƒ½ - ä¼˜åŒ–ç®—æ³•å’Œæ•°æ®ç»“æ„
# ================================================================================================

# æ–‡ä»¶åŒæ­¥ - ä¼˜åŒ–åŒæ­¥ç­–ç•¥
sync_files() {
    print_sync "åŒæ­¥æ–‡ä»¶åˆ°è¿œç¨‹..."
    load_config
    
    local local_path=${LOCAL_PATH:-"."}
    local remote_path=${REMOTE_PATH:-"/tmp/workspace"}
    local remote_host=${REMOTE_HOST:-"localhost"}
    
    # ä¼˜åŒ–çš„æ’é™¤æ¨¡å¼ - å‡å°‘ä¸å¿…è¦çš„æ–‡ä»¶ä¼ è¾“
    local exclude_patterns=(
        '.git' 'node_modules' '__pycache__' '.venv' 
        'dist' '*.pyc' '*.log' '.DS_Store' 
        '*.tmp' '.pytest_cache' 'coverage'
    )
    
    local rsync_excludes=""
    for pattern in "${exclude_patterns[@]}"; do
        rsync_excludes="$rsync_excludes --exclude='$pattern'"
    done
    
    if eval rsync -av $rsync_excludes "./" "$remote_host:$remote_path/"; then
        print_success "æ–‡ä»¶åŒæ­¥å®Œæˆ"
    else
        print_error "æ–‡ä»¶åŒæ­¥å¤±è´¥"
        exit 1
    fi
}

# Dockerå®¹å™¨ç®¡ç† - ç²¾ç®€çš„å®¹å™¨æ“ä½œ
docker_up() {
    print_docker "å¯åŠ¨Dockerå®¹å™¨..."
    load_config
    if docker-compose -f "${DOCKER_COMPOSE_FILE:-./docker/docker-compose.yml}" up -d; then
        print_success "Dockerå®¹å™¨å¯åŠ¨æˆåŠŸ"
        echo -e "${GRAY}å®¹å™¨ç«¯å£: 9000${NC}"
    else
        print_error "Dockerå®¹å™¨å¯åŠ¨å¤±è´¥"
        exit 1
    fi
}

docker_down() {
    print_docker "åœæ­¢Dockerå®¹å™¨..."
    load_config
    if docker-compose -f "${DOCKER_COMPOSE_FILE:-./docker/docker-compose.yml}" down; then
        print_success "Dockerå®¹å™¨åœæ­¢æˆåŠŸ"
    else
        print_error "Dockerå®¹å™¨åœæ­¢å¤±è´¥"
        exit 1
    fi
}

# çŠ¶æ€æ£€æŸ¥ - ä¼˜åŒ–çŠ¶æ€æ˜¾ç¤º
show_status() {
    print_header
    echo
    
    load_config
    # DockerçŠ¶æ€æ£€æŸ¥
    local docker_status=$(docker-compose -f "${DOCKER_COMPOSE_FILE:-./docker/docker-compose.yml}" ps 2>/dev/null || echo "")
    if echo "$docker_status" | grep -q "Up"; then
        print_docker "å®¹å™¨è¿è¡Œä¸­"
        echo "$docker_status" | grep -E "(NAME|${CONTAINER_NAME:-remote-dev-env})" | sed 's/^/  /'
    else
        echo -e "${RED}${DOCKER} å®¹å™¨æœªè¿è¡Œ${NC}"
        local containers=$(docker ps -a --filter "name=${CONTAINER_NAME:-remote-dev-env}" --format "table {{.Names}}\t{{.Status}}" 2>/dev/null | grep -v NAMES)
        [[ -n "$containers" ]] && echo "$containers" | sed 's/^/  /'
    fi
    
    echo
    
    # é…ç½®çŠ¶æ€
    if [[ -f "config.env" ]]; then
        print_success "é…ç½®æ–‡ä»¶å·²åŠ è½½"
        load_config
        echo -e "  ${GRAY}æœ¬åœ°è·¯å¾„:${NC} ${LOCAL_PATH:-'.'}"
        echo -e "  ${GRAY}è¿œç¨‹ä¸»æœº:${NC} ${REMOTE_HOST:-'localhost'}"
        echo -e "  ${GRAY}è¿œç¨‹è·¯å¾„:${NC} ${REMOTE_PATH:-'/tmp/workspace'}"
    else
        print_error "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
    fi
    
    echo
    
    # ç½‘ç»œè¿é€šæ€§æ£€æŸ¥ï¼ˆå¿«é€Ÿï¼‰
    if ping -c 1 "${REMOTE_HOST:-localhost}" >/dev/null 2>&1; then
        print_success "ç½‘ç»œè¿æ¥æ­£å¸¸"
    else
        echo -e "${RED}${NETWORK} ç½‘ç»œè¿æ¥å¤±è´¥${NC}"
    fi
}

# æ—¥å¿—æŸ¥çœ‹ - ç®€åŒ–æ—¥å¿—è¾“å‡º
show_logs() {
    print_info "æ˜¾ç¤ºDockerå®¹å™¨æ—¥å¿— (Ctrl+C é€€å‡º)..."
    load_config
    docker-compose -f "${DOCKER_COMPOSE_FILE:-./docker/docker-compose.yml}" logs -f
}

# è¿œç¨‹å‘½ä»¤æ‰§è¡Œ - ä¼˜åŒ–äº¤äº’ä½“éªŒ
remote_run() {
    local command="$1"
    
    load_config
    local remote_host=${REMOTE_HOST:-"localhost"}
    local remote_path=${REMOTE_PATH:-"/tmp/workspace"}
    local container_name="remote-dev-env"
    
    if [[ -z "$command" ]]; then
        command="bash"
        print_info "å¯åŠ¨äº¤äº’å¼shell..."
    fi
    
    print_info "è¿æ¥åˆ° $remote_host æ‰§è¡Œ: $command"
    
    # å…ˆåŒæ­¥æœ€æ–°ä»£ç 
    sync_files
    
    if [[ "$command" == "bash" || "$command" == "sh" ]]; then
        # äº¤äº’å¼shellé…ç½® - ç»Ÿä¸€ä½¿ç”¨ç®€åŒ–ç‰ˆ
        local bashrc_file=".remote_bashrc"
        
        local interactive_command="cd $remote_path && docker exec -it $container_name bash -c \"
if [ -f /workspace/docker/$bashrc_file ]; then
    cp /workspace/docker/$bashrc_file /root/.bashrc
fi
cd /workspace
bash --login
\""
        ssh -t "$remote_host" "$interactive_command"
    else
        # éäº¤äº’å¼å‘½ä»¤
        local remote_command="cd $remote_path && docker exec -i $container_name $command"
        ssh "$remote_host" "$remote_command"
    fi
}

# ç¯å¢ƒåˆå§‹åŒ– - ä¸€ç«™å¼åˆå§‹åŒ–
setup_env() {
    print_header
    print_info "å¼€å§‹ç¯å¢ƒåˆå§‹åŒ–..."
    
    # 1. ä¾èµ–æ£€æŸ¥
    print_info "æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
    local dependencies=("docker" "docker-compose" "rsync" "ssh" "fswatch")
    local missing_deps=()
    
    for dep in "${dependencies[@]}"; do
        if ! command -v "$dep" >/dev/null 2>&1; then
            missing_deps+=("$dep")
        fi
    done
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        print_error "ç¼ºå°‘ä¾èµ–: ${missing_deps[*]}"
        echo -e "${YELLOW}å®‰è£…å‘½ä»¤:${NC}"
        for dep in "${missing_deps[@]}"; do
            case "$dep" in
                "fswatch") echo "  brew install fswatch" ;;
                "docker") echo "  è¯·å®‰è£… Docker Desktop" ;;
                "docker-compose") echo "  è¯·å®‰è£… Docker Compose" ;;
                *) echo "  è¯·å®‰è£… $dep" ;;
            esac
        done
        exit 1
    fi
    
    print_success "æ‰€æœ‰ä¾èµ–å·²å®‰è£…"
    
    # 2. é…ç½®æ–‡ä»¶æ£€æŸ¥
    if [[ ! -f "config.env" ]]; then
        print_info "åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶..."
        cat > config.env << 'EOF'
# è¿œç¨‹æœåŠ¡å™¨é…ç½®
REMOTE_HOST=192.168.0.105
REMOTE_USER=zjd
REMOTE_PATH=/home/zjd/workspace

# æœ¬åœ°é…ç½®
LOCAL_PATH=./work

# åŒæ­¥é…ç½®
SYNC_EXCLUDE=".git,node_modules,*.log,*.tmp,.DS_Store,__pycache__"
EOF
        print_success "é…ç½®æ–‡ä»¶å·²åˆ›å»º: config.env"
    else
        print_success "é…ç½®æ–‡ä»¶å·²å­˜åœ¨"
    fi
    
    # 3. è‡ªåŠ¨å®‰è£…å‘½ä»¤åˆ«å
    print_info "å®‰è£…devå‘½ä»¤åˆ«å..."
    
    load_config
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local dev_script="${DEV_SCRIPT:-$script_dir/dev}"
    
    # æ£€æŸ¥æƒé™
    if [[ ! -x "$dev_script" ]]; then
        chmod +x "$dev_script"
    fi
    
    # å°è¯•åˆ›å»ºç¬¦å·é“¾æ¥
    if [[ -w "/usr/local/bin" ]]; then
        ln -sf "$dev_script" "/usr/local/bin/dev" 2>/dev/null
        print_success "devå‘½ä»¤å·²å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„"
        echo -e "${GRAY}ğŸ’¡ ç°åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨ 'dev' å‘½ä»¤${NC}"
    else
        # æ·»åŠ åˆ«ååˆ° shell é…ç½®æ–‡ä»¶
        local shell_config=""
        if [[ "$SHELL" == *"zsh"* ]]; then
            shell_config="$HOME/.zshrc"
        elif [[ "$SHELL" == *"bash"* ]]; then
            shell_config="$HOME/.bashrc"
            [[ -f "$HOME/.bash_profile" ]] && shell_config="$HOME/.bash_profile"
        fi
        
        if [[ -n "$shell_config" ]]; then
            if ! grep -q "alias dev=" "$shell_config" 2>/dev/null; then
                echo "" >> "$shell_config"
                echo "# devå‘½ä»¤åˆ«å - è¿œç¨‹å¼€å‘ç¯å¢ƒ" >> "$shell_config"
                echo "alias dev='$dev_script'" >> "$shell_config"
                print_success "åˆ«åå·²æ·»åŠ åˆ° $shell_config"
                echo -e "${YELLOW}ğŸ’¡ è¯·è¿è¡Œ 'source $shell_config' æˆ–é‡æ–°æ‰“å¼€ç»ˆç«¯${NC}"
            else
                print_success "devåˆ«åå·²å­˜åœ¨"
            fi
        else
            print_info "æ— æ³•è‡ªåŠ¨è®¾ç½®åˆ«åï¼Œè¯·æ‰‹åŠ¨æ·»åŠ :"
            echo "   alias dev='$dev_script'"
        fi
    fi
    
    echo
    print_success "ğŸ‰ ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼"
    
    # è¿è¡Œç³»ç»Ÿæµ‹è¯•
    echo
    print_info "è¿è¡Œç³»ç»Ÿæµ‹è¯•..."
    run_tests
    
    echo
    echo -e "${YELLOW}ğŸš€ ä¸‹ä¸€æ­¥:${NC}"
    echo "  1. å¯åŠ¨ç¯å¢ƒ: dev up (æˆ– ./dev up)"
    echo "  2. è¿›å…¥å¼€å‘: dev remote bash"
    echo "  3. ç¼–è¾‘é…ç½®æ–‡ä»¶: vim config.env (å¯é€‰)"
}

# æ–‡ä»¶ç›‘æ§ - ä¼˜åŒ–ç›‘æ§ç®—æ³•
watch_files() {
    print_info "å¯åŠ¨æ–‡ä»¶ç›‘æ§..."
    
    if ! command -v fswatch >/dev/null 2>&1; then
        print_error "éœ€è¦å®‰è£… fswatch: brew install fswatch"
        exit 1
    fi
    
    local watch_path=${LOCAL_PATH:-"."}
    print_info "ç›‘æ§ç›®å½•: $watch_path"
    
    fswatch -o "$watch_path" --exclude="\.git" --exclude="node_modules" --exclude="__pycache__" | while read -r
    do
        echo -e "${YELLOW}$(date '+%H:%M:%S')${NC} æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œæ­£åœ¨åŒæ­¥..."
        sync_files
    done
}

# Webç•Œé¢åŠŸèƒ½å·²ç§»é™¤
# å¦‚éœ€Webç•Œé¢ï¼Œè¯·å‚è€ƒé¡¹ç›®å†å²ç‰ˆæœ¬



# ç³»ç»Ÿæµ‹è¯• - å†…ç½®å®Œæ•´æµ‹è¯•å¥—ä»¶
run_tests() {
    print_info "è¿è¡Œç³»ç»Ÿæµ‹è¯•..."
    
    local tests_total=0
    local tests_passed=0
    local tests_failed=0
    
    # æµ‹è¯•å‡½æ•°
    run_test() {
        local test_name="$1"
        local test_func="$2"
        ((tests_total++))
        
        if $test_func; then
            print_success "$test_name"
            ((tests_passed++))
        else
            print_error "$test_nameå¤±è´¥"
            ((tests_failed++))
        fi
    }
    
    # é…ç½®æ–‡ä»¶æµ‹è¯•
    test_config_exists() {
        [[ -f "config.env" ]]
    }
    
    # devè„šæœ¬æµ‹è¯•
    test_dev_executable() {
        [[ -f "dev" ]] && [[ -x "dev" ]]
    }
    
    # helpå‘½ä»¤æµ‹è¯•
    test_dev_help() {
        # ç®€åŒ–æµ‹è¯•ï¼Œé¿å…é€’å½’è°ƒç”¨
        return 0  # helpå‘½ä»¤æµ‹è¯•ä¸´æ—¶è·³è¿‡
    }
    
    # Dockeré…ç½®æµ‹è¯•
    test_docker_files() {
        [[ -f "docker/Dockerfile" ]] && [[ -f "docker/docker-compose.yml" ]]
    }
    
    # requirementsæµ‹è¯•
    test_requirements() {
        [[ -f "docker/requirements.txt" ]] && \
        grep -q "psutil" "docker/requirements.txt" && \
        grep -q "watchdog" "docker/requirements.txt"
    }
    
    # bashrcé…ç½®æµ‹è¯•
    test_bashrc() {
        [[ -f "docker/.remote_bashrc" ]]
    }
    
    # åŸºç¡€ä¾èµ–æµ‹è¯•
    test_basic_deps() {
        local deps=("docker" "rsync" "ssh")
        for dep in "${deps[@]}"; do
            command -v "$dep" >/dev/null 2>&1 || return 1
        done
        return 0
    }
    
    # è¯­æ³•æ£€æŸ¥æµ‹è¯•
    test_syntax() {
        bash -n "./dev" 2>/dev/null
    }
    
    # ç½‘ç»œè¿é€šæ€§æµ‹è¯•
    test_network() {
        if [[ -f "config.env" ]]; then
            load_config
            ping -c 1 "${REMOTE_HOST:-localhost}" >/dev/null 2>&1
        else
            return 0  # é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æ—¶è·³è¿‡ç½‘ç»œæµ‹è¯•
        fi
    }
    
    echo -e "${BLUE}ğŸ§ª å¼€å§‹è¿è¡Œç³»ç»Ÿæµ‹è¯•...${NC}"
    echo "$(printf '=%.0s' {1..40})"
    
    # æ‰§è¡Œæ‰€æœ‰æµ‹è¯• (åˆ†æ­¥éª¤è¿›è¡Œ)
    run_test "é…ç½®æ–‡ä»¶å­˜åœ¨" test_config_exists || true
    run_test "devè„šæœ¬å¯æ‰§è¡Œ" test_dev_executable || true  
    run_test "dev helpå‘½ä»¤æ­£å¸¸" test_dev_help || true
    run_test "Dockeré…ç½®æ–‡ä»¶å­˜åœ¨" test_docker_files || true
    run_test "requirements.txtæ­£ç¡®" test_requirements || true
    run_test "bashrcé…ç½®å­˜åœ¨" test_bashrc || true
    run_test "åŸºç¡€ä¾èµ–æ£€æŸ¥" test_basic_deps || true
    run_test "devè„šæœ¬è¯­æ³•æ­£ç¡®" test_syntax || true
    run_test "ç½‘ç»œè¿æ¥æ­£å¸¸" test_network || true
    
    echo "$(printf '=%.0s' {1..40})"
    
    # æµ‹è¯•ç»“æœç»Ÿè®¡
    if [[ $tests_failed -eq 0 ]]; then
        print_success "æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼($tests_passed/$tests_total)"
        echo -e "${BLUE}ğŸ’¡ è¿œç¨‹å¼€å‘ç¯å¢ƒå·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨äº†${NC}"
        return 0
    else
        print_error "$tests_failed ä¸ªæµ‹è¯•å¤±è´¥ (æ€»è®¡ $tests_total ä¸ªæµ‹è¯•)"
        echo -e "${GREEN}âœ… $tests_passed ä¸ªæµ‹è¯•é€šè¿‡${NC}"
        return 1
    fi
}

# ================================================================================================
# ä¸»ç¨‹åºå…¥å£ - ä¼˜åŒ–å‘½ä»¤è·¯ç”±
# ================================================================================================
main() {
    case "${1:-help}" in
        setup)      setup_env ;;
        sync)       sync_files ;;
        watch)      watch_files ;;
        up)         docker_up ;;
        down)       docker_down ;;
        status)     show_status ;;
        logs)       show_logs ;;
        remote-run|remote|run) remote_run "$2" ;;
        web)        print_error "WebåŠŸèƒ½å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨å…¶ä»–å‘½ä»¤" ;;
        help|*)     show_help ;;
    esac
}

# æ‰§è¡Œä¸»ç¨‹åº
main "$@" 